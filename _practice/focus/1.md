模块化设计

本节讨论使用模糊测试检测DBMS的内存漏洞。
综述
数据库管理系统 (database management system, DBMS) 是一种用于存储、管理、分析数据的大型基础软件。DBMS的漏洞会导致：
1.数据库非正常运行，进而影响上层活动，比如用户登录、金融交易。
2.错误的数据操作，信息泄漏或篡改数据库内部存储的敏感信息。
3.造成DoS、提权或者代码执行。

DBMS有以下四个必要的组成部分：
1.服务器端，服务器端作为运行的进程，根据本地/远程连接发送的SQL/COMMAND，进行解析，检验语法和语义，在数据库中执行相应的操作。
2.数据库，一个DBMS管理多个数据库，比如Postgresql通过psql -U [user] -d [db]来指定用户访问特定数据库；Redis使用SELECT命令来切换数据库。
3.语句(SQL/NRO)，对于关系型数据库，需要指定结构化查询语言 (structured query language, SQL)，对于非关系型数据库，需要指定非关系型操作(no-relation operation,NRO)。
4.元数据，元数据是关于数据的数据，在关系型数据库中，表、列和触发器等等是元数据；在键值型数据库中，键可以是元数据，作为关于值的数据。

测试用例合成方法
基于模糊测试的DBMS漏洞检测，关键在于生成语法和语义正确的测试用例。根据测试用例合成方法的不同，可以分为以下三类：基于AST的生成、基于IR的变异和基于元数据图的用例重组。
需要注意的是，以上三类只有基于元数据图的用例重组适用于非关系型数据库(待验证)。

DBMS的模糊测试结构
根据与DBMS交互的方式，可以分成C/S模式和单程序模式。大部分的DBMS是C/S模式的，例如Postgres、Redis。单程序模式的有sqlite。
首先需要插桩，使用afl-cc、afl-clang-lto等工具对开源DBMS进行编译时插桩，或者使用zafl等工具对闭源DBMS进行静态插桩。
单程序模式的DBMS模糊测试，结构如下：
1.一个提供给afl-fuzz调用的定制变异器动态库。
2.单程序模式，核心操作在动态库中，所以需要一个harness调用该动态库。
3.afl-fuzz启动harness，同时会收集动态库的覆盖率。
C/S模式的DBMS模糊测试，结构如下：
1.开辟一片共享内存，在启动服务器时传递shmid，服务器端统计的覆盖率将存储在共享内存中。
2.一个提供给afl-fuzz调用(可能是RPC调用)的定制变异器动态库。
3.一个控制模糊测试流程的驱动程序，通过pipe管道向afl-fuzz发送控制信息来取代forkserver。afl-fuzz启动驱动程序，传递shmid，使得afl-fuzz能够通过驱动程序获取服务器进程的覆盖率。

大部分的DBMS都是C/S模式的，三个主要组成部分：服务器端、afl-fuzz和驱动程序